
<style>
.znc{line-height:1.9}.znc>*:first-child{margin-top:0}.znc i,.znc cite,.znc em{font-style:italic}.znc strong{font-weight:700}.znc a{color:#0f83fd}.znc a:hover{text-decoration:underline}.znc p+p{margin-top:1.5em}.znc ul,.znc ol{margin:1.4rem 0;line-height:1.7}.znc ul>li,.znc ol>li{margin:.4rem 0}.znc ul ul,.znc ul ol,.znc ol ul,.znc ol ol{margin:.2em 0}.znc ul p,.znc ol p{margin:0}.znc ul{padding-left:1.8em}.znc ul>li{list-style:disc}.znc ul>li::marker{font-size:1.1em;color:#5e6478}.znc ol{padding-left:1.7em}.znc ol>li{list-style:decimal;padding-left:.2em}.znc ol>li::marker{color:#535872;font-weight:600;letter-spacing:-0.05em}.znc .contains-task-list li{list-style:none !important}.znc .task-list-item-checkbox{margin-left:-1.5em;font-size:1em;pointer-events:none}.znc h1+p,.znc h2+p,.znc h3+p,.znc h4+p,.znc h5+p,.znc h6+p{margin-top:.3em}.znc h1,.znc h2{margin-top:2.3em;margin-bottom:.5em}.znc h3,.znc h4,.znc h5,.znc h6{margin-top:2.25em;margin-bottom:.5em}.znc h1{padding-bottom:.2em;margin-bottom:1.1rem;font-size:1.7em;position:relative;border-bottom:solid 1px rgba(92,147,187,.17)}.znc h2{font-size:1.5em}.znc h3{font-size:1.3em}.znc h4{font-size:1.1em}.znc h5{font-size:1em}.znc h6{font-size:.9em}@media screen and (max-width: 576px){.znc h1{font-size:1.6em}.znc h2{font-size:1.4em}.znc h3{font-size:1.2em}.znc h4{font-size:1.1em}.znc h5{font-size:1em}.znc h6{font-size:.85em}}.znc hr{border-top:2px solid rgba(92,147,187,.17);margin:2.5rem 0}.znc blockquote{font-size:.97em;margin:1.4rem 0;border-left:solid 3px #9dacb7;padding:2px 0 2px .7em;color:#505c64}.znc blockquote p{margin:1rem 0}.znc blockquote>:first-child{margin-top:0}.znc blockquote>:last-child{margin-bottom:0}.znc blockquote.twitter-tweet{display:none}.znc table{margin:1.2rem auto;width:auto;border-collapse:collapse;font-size:.95em;line-height:1.5;word-break:normal;display:block;overflow:auto;-webkit-overflow-scrolling:touch}.znc th,.znc td{padding:.5rem;border:solid 1px #cfdce6;background:#fff}.znc th{font-weight:700;background:#edf2f7}.znc code{padding:.2em .4em;background:rgba(33,90,160,.07);font-size:.85em;border-radius:4px;vertical-align:.08em}.znc code,.znc .code-block-filename{font-family:"SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";-webkit-font-smoothing:antialiased}.znc pre{margin:1.3rem 0;background:#1a2638;overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:.7em;box-shadow:0 4px 6px -1px rgba(0,14,30,.15);word-break:normal;word-wrap:normal;display:flex}.znc pre:after{content:"";width:8px;flex-shrink:0}.znc pre code{margin:0;padding:0;background:transparent;font-size:.9em;color:#fff}.znc pre>code{display:block;padding:1.1rem}@media screen and (max-width: 576px){.znc pre>code{padding:1rem .8rem;font-size:.85em}}.znc .code-block-container{position:relative;margin:1.3rem 0}.znc .code-block-container pre{margin:0}.znc .code-block-filename{display:table;max-width:100%;background:#323e52;color:rgba(255,255,255,.9);font-size:12px;line-height:1.3;border-radius:6px 6px 0 0;padding:6px 12px 20px;margin-bottom:-16px}.znc .code-block-filename-container+pre{border-top-left-radius:0}.znc img:not(.emoji){margin:1.5rem auto;display:table;max-width:100%;height:auto}.znc img+br{display:none}.znc img~em{display:block;margin:-1rem auto 0;line-height:1.3;text-align:center;color:#77838c;font-size:.92em}.znc details{font-size:.95em;margin:1rem 0;line-height:1.7}.znc summary{cursor:pointer;outline:0;padding:.7em .7em .7em .9em;border:solid 1px rgba(92,147,187,.19);color:var(--c-contrast);font-size:.9em;border-radius:9px;box-shadow:0 2px 4px -2px rgba(0,0,0,.15)}.znc summary::-webkit-details-marker{color:#77838c}.znc details[open] summary{border-radius:5px 5px 0 0;box-shadow:none;background:#f1f5f9;border-bottom:none}.znc .details-content{padding:.5em .9em;border:solid 1px rgba(92,147,187,.2);border-radius:0 0 5px 5px}.znc .details-content>*{margin:.5em 0}.znc .embed-tweet,.znc .embed-gist,.znc .embed-speakerdeck,.znc .embed-slideshare,.znc .embed-codepen,.znc .embed-jsfiddle,.znc .embed-youtube,.znc .embed-codesandbox,.znc .embed-stackblitz,.znc .embed-mermaid{margin:1.5rem 0}.znc .embed-slideshare,.znc .embed-speakerdeck,.znc .embed-codepen,.znc .embed-jsfiddle,.znc .embed-youtube,.znc .embed-stackblitz{padding-bottom:calc(56.25% + 38px);position:relative;width:100%;height:0}.znc .embed-slideshare iframe,.znc .embed-speakerdeck iframe,.znc .embed-codepen iframe,.znc .embed-jsfiddle iframe,.znc .embed-youtube iframe,.znc .embed-stackblitz iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none}.znc .embed-slideshare iframe{border:1px solid #1a2638}.znc .embed-zenn-link{margin:1rem auto}.znc .embed-zenn-link iframe{height:125px;width:100%;display:block}.znc embed-katex:not([display-mode="1"]){display:inline-flex;overflow-x:auto;max-width:100%;-ms-overflow-style:none;scrollbar-width:none}.znc embed-katex:not([display-mode="1"])::-webkit-scrollbar{display:none}.znc embed-katex[display-mode="1"]{display:block;width:100%;overflow-x:auto}.znc embed-mermaid svg{height:auto}.znc pre.zenn-mermaid{background:transparent;color:#93a5b1;font-size:.9rem}.znc pre[class*=language-]{position:relative}.znc .token.namespace{opacity:.7}.znc .token.comment,.znc .token.prolog,.znc .token.doctype,.znc .token.cdata{color:#94a1b3}.znc .token.operator,.znc .token.boolean,.znc .token.number{color:#ffc56d}.znc .token.attr-name,.znc .token.string{color:#ffc56d}.znc .token.entity,.znc .token.url,.znc .language-css .token.string,.znc .style .token.string{color:#ffc56d}.znc .token.selector{color:#ff8fa3}.znc .token.atrule,.znc .token.attr-value,.znc .token.keyword,.znc .token.important{color:#ff8fa3}.znc .token.deleted{color:#ff8fa3}.znc .token.inserted{color:#b4ff9b}.znc .token.deleted:not(.prefix){background:rgba(218,54,50,.2);color:inherit;display:block}.znc .token.prefix{user-select:none}.znc .token.inserted:not(.prefix){background:rgba(0,146,27,.2);color:inherit;display:block}.znc .token.prefix.unchanged{display:none}.znc .token.unchanged>.token.prefix.unchanged{display:inline}.znc .token.coord{color:#aad4ff}.znc .token.regex,.znc .token.statement{color:#ffc56d}.znc .token.placeholder,.znc .token.variable{color:#fff}.znc .token.important,.znc .token.statement,.znc .token.bold{font-weight:700}.znc .token.punctuation{color:#939bc1}.znc .token.entity{cursor:help}.znc .token.italic{font-style:italic}.znc .token.tag,.znc .token.property,.znc .token.function{color:#38c7ff}.znc .token.attr-name{color:#ff8fa3}.znc .token.attr-value{color:#ffc56d}.znc .token.style,.znc .token.script{color:#ffc56d}.znc .token.script .token.keyword{color:#ffc56d}.znc aside.msg{display:flex;align-items:flex-start;margin:1.5rem 0;padding:1.4em 1em;border-radius:10px;background:#fff6e4;color:rgba(0,0,0,.65);font-size:.94em;line-height:1.6}.znc aside.msg.alert{background:#ffeff2}.znc aside.msg a{color:inherit;text-decoration:underline}.znc .msg-icon{position:relative;top:.05em;width:1.4em;height:1.4em;color:#ffb84c}.znc aside.msg.alert .msg-icon{color:#ff7670}.znc .msg-content{flex:1;margin-left:.6em}.znc .msg-content>*{margin:.7rem 0}.znc .msg-content>*:first-child,.znc .msg-content>*:last-child{margin:0}.znc .footnotes{margin-top:3rem;color:#77838c;font-size:.9em}.znc .footnotes li::marker{color:#77838c}.znc .footnotes-title{padding-bottom:3px;border-bottom:solid 1px #cfdce6;font-weight:700;font-size:15px}.znc .footnotes-list{margin:13px 0 0}.znc .footnotes-twemoji{border:none;margin:0 7px 0 0;vertical-align:-3px}

svg {
  width: 20px;
}
</style>
<div class="znc">
  <hr>
<h2 id="title%3A-%22slack%E3%81%AE%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%921%E3%81%A4%E3%81%AE%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AB%E9%9B%86%E7%B4%84%E3%81%99%E3%82%8Bslack%E3%83%9C%E3%83%83%E3%83%88%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%22emoji%3A-%22%F0%9F%92%AC%22type%3A-%22tech%22-%23-tech%3A-%E6%8A%80%E8%A1%93%E8%A8%98%E4%BA%8B-%2F-idea%3A-%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2topics%3A-%5B%22slack%22%2C-%22gas%22%2C-%22googleappsscrip%22%5Dpublished%3A-true"><a class="header-anchor-link" href="#title%3A-%22slack%E3%81%AE%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%82%921%E3%81%A4%E3%81%AE%E3%83%81%E3%83%A3%E3%83%B3%E3%83%8D%E3%83%AB%E3%81%AB%E9%9B%86%E7%B4%84%E3%81%99%E3%82%8Bslack%E3%83%9C%E3%83%83%E3%83%88%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F%22emoji%3A-%22%F0%9F%92%AC%22type%3A-%22tech%22-%23-tech%3A-%E6%8A%80%E8%A1%93%E8%A8%98%E4%BA%8B-%2F-idea%3A-%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2topics%3A-%5B%22slack%22%2C-%22gas%22%2C-%22googleappsscrip%22%5Dpublished%3A-true" aria-hidden="true"></a> title: &quot;Slackのチャンネルのメッセージを1つのチャンネルに集約するSlackボットを作ってみた&quot;<br>
emoji: &quot;💬&quot;<br>
type: &quot;tech&quot; # tech: 技術記事 / idea: アイデア<br>
topics: [&quot;slack&quot;, &quot;gas&quot;, &quot;googleappsscrip&quot;]<br>
published: true</h2>
<p>作ろうとした背景としてメンバー各位が書く分報チャンネルがあってチャンネル参加してなくても一括に確認できるようなものがあったらいいなと思っていたので作ってみた感じです。</p>
<p>Slackの分報を社内Twitterに！皆の分報を一つのチャネルに集約するSlackボットを作ってみた<br style="display: none">
<div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fzenn.dev%2Fryo_kawamata%2Farticles%2Ftimes-all-bot" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://zenn.dev/ryo_kawamata/articles/times-all-bot" style="display: none" target="_blank">https://zenn.dev/ryo_kawamata/articles/times-all-bot</a><br style="display: none">
のパクリですがGAS版として投稿しています。</p>
<h2 id="%E4%BD%9C%E6%88%90%E7%89%A9"><a class="header-anchor-link" href="#%E4%BD%9C%E6%88%90%E7%89%A9" aria-hidden="true"></a> 作成物</h2>
<p><div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fgithub.com%2Figara%2Fbot_slack_matome_channnel" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://github.com/igara/bot_slack_matome_channnel" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://github.com/igara/bot_slack_matome_channnel</a></p>
<p><img src="/images/bot_slack_matome_channnel/slack_bot_message.gif" alt=""></p>
<p>オプションで集約したくないチャンネルの場合は無視できるようなものを作成しました。</p>
<aside class="msg message"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 101 101" role="img" aria-label="message" class="msg-icon"><circle cx="51" cy="51" r="50" fill="currentColor"></circle><text x="50%" y="50%" text-anchor="middle" fill="#ffffff" font-size="70" font-weight="bold" dominant-baseline="central">!</text></svg><div class="msg-content"><p>GASなので利用回数の制限があるので注意です。<br>
<a href="https://developers.google.com/apps-script/guides/services/quotas" target="_blank" rel="nofollow noopener noreferrer">https://developers.google.com/apps-script/guides/services/quotas</a></p>
<p>2021/04/20時点では</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Consumer (e.g., gmail.com) and G Suite free edition(legacy)</th>
<th>Google Workspace accounts</th>
</tr>
</thead>
<tbody>
<tr>
<td>Triggers total runtime</td>
<td>90 min / day</td>
<td>6 hr / day</td>
</tr>
<tr>
<td>URL Fetch calls</td>
<td>20,000 / day</td>
<td>100,000 / day</td>
</tr>
</tbody>
</table>
<p>と記載されていますので規模感に合わせてGASじゃない実装にしたほうが良いというのもありそうです。<br>
TriggerはSlackの情報をSpreadsheetにキャッシュさせるために使用したり、<br>
URL FetchはSlackにメッセージを流すために使用していますので上記の上限できびしいなと思ったらこの記事を参考にしないほうがいいと思います。</p>
</div></aside>
<h2 id="%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97"><a class="header-anchor-link" href="#%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97" aria-hidden="true"></a> セットアップ</h2>
<h3 id="slack%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AEscope%E8%A8%AD%E5%AE%9A"><a class="header-anchor-link" href="#slack%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AEscope%E8%A8%AD%E5%AE%9A" aria-hidden="true"></a> Slackアプリのscope設定</h3>
<p><a href="https://api.slack.com/apps" target="_blank" rel="nofollow noopener noreferrer">https://api.slack.com/apps</a> からアプリを作成し、<br>
<strong>OAuth &amp; Permissions</strong> の画面から以下のscopeをBot Userに追加します。</p>
<ul>
<li>channels:history</li>
<li>channels:read</li>
<li>chat:write</li>
<li>users.profile:read</li>
<li>users:read</li>
<li>users:read.email</li>
</ul>
<p>usersのscopeはSpreadsheetに情報を残した際にメールアドレスもGoogle Workspaceとの連携も楽そうという未来実装的に入れているものなので本題では不要なscopeだったりします。</p>
<p><img src="/images/bot_slack_matome_channnel/slack_bot_scope.jpg" alt=""></p>
<p>設定が完了したら <strong>OAuth &amp; Permissions</strong> の画面上部にある <strong>Bot User OAuth Token</strong> の値をコピーしましょう。</p>
<h3 id="gas%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90"><a class="header-anchor-link" href="#gas%E3%81%AE%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90" aria-hidden="true"></a> GASのプロジェクトを作成</h3>
<p>下記コマンドからソースを持ってきます。</p>
<div class="code-block-container"><pre class=""><code class="">git clone https://github.com/igara/bot_slack_matome_channnel.git
cd bot_slack_matome_channnel
</code></pre></div><p>環境変数の適応を行います。</p>
<div class="code-block-container"><pre class=""><code class="">cp .env.sample.ts .env.ts
</code></pre></div><div class="code-block-container"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// Slackのチーム名</span>
  <span class="token constant">SLACK_TEAM</span><span class="token operator">:</span> <span class="token string">"hoge"</span><span class="token punctuation">,</span>
  <span class="token comment">// OAuth &amp; Permissionsのページに記載されてたBot User OAuth Token</span>
  <span class="token constant">SLACK_ACCESS_TOKEN</span><span class="token operator">:</span> <span class="token string">"xoxb-xxxxx-xxxxx-xxxxx"</span><span class="token punctuation">,</span>
  <span class="token comment">// メッセージを送りたい対象のチャンネル名</span>
  <span class="token constant">BOT_SLACK_MATOME_CHANNEL_NAME</span><span class="token operator">:</span> <span class="token string">"bot_slack_matome_channnel"</span><span class="token punctuation">,</span>
  <span class="token comment">// 集約したい対象のチャンネル名の正規表現 下記は分報チャンネル想定</span>
  <span class="token constant">TARGET_CHANNEL_REGEXES</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^t_\S*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^time_\S*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// TARGET_CHANNEL_REGEXESの中から除外したいチャンネルの正規表現</span>
  <span class="token constant">IGNORE_TARGET_CHANNEL_REGEXES</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^t_ignore_\S*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^time_ignore_\S*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下記のコマンドからSpreadsheet &amp; GASを作成します</p>
<div class="code-block-container"><pre class=""><code class="">npm install

# login
npx clasp login

# new create spreadsheet &amp; script project &amp; .clasp.json
npm run new name=hoge

# build
npm run build
# push
npx clasp push
</code></pre></div><p>上記を実行するとSpreadsheetが作成され、その中にあるスクリプトエディターを開くとGASも追加されているかと思います。</p>
<p><img src="/images/bot_slack_matome_channnel/create_spreadsheet.jpg" alt=""></p>
<p><img src="/images/bot_slack_matome_channnel/create_gas.jpg" alt=""></p>
<h3 id="spreadsheet%E3%81%ABslack%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80"><a class="header-anchor-link" href="#spreadsheet%E3%81%ABslack%E3%81%AE%E6%83%85%E5%A0%B1%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80" aria-hidden="true"></a> SpreadsheetにSlackの情報を読み込む</h3>
<p>スクリプトエディターから下記の関数を実行してSlackの情報をSpreadsheetに残します。</p>
<ul>
<li><strong>create_sheets.ts.gs</strong> の <strong>createSheets</strong> を実行して必要なシートを作成</li>
<li><strong>get_channels.ts.gs</strong> の <strong>getChannels</strong> を実行してシートにチャンネルの情報を残す</li>
<li><strong>get_users.ts.gs</strong> の <strong>getUsers</strong> を実行してシートにユーザの情報を残す</li>
</ul>
<p>スクリプトエディターを経由しないで実行する方法として</p>
<p><div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fqiita.com%2Fjiroshin%2Fitems%2Fdcc398285c652554e66a%23%25E3%2583%25AD%25E3%2583%25BC%25E3%2582%25AB%25E3%2583%25AB%25E3%2581%258B%25E3%2582%2589gas%25E3%2582%2592%25E5%258F%25A9%25E3%2581%258F" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://qiita.com/jiroshin/items/dcc398285c652554e66a#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%8B%E3%82%89gas%E3%82%92%E5%8F%A9%E3%81%8F" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://qiita.com/jiroshin/items/dcc398285c652554e66a#ローカルからgasを叩く</a></p>
<p>にあるようなGoogle Cloud Consoleと自前で作成したClaspのログインができていれば</p>
<div class="code-block-container"><pre class=""><code class="">npx clasp run createSheets
npx clasp run getChannels
npx clasp run getUsers
</code></pre></div><p>というようなコマンドで実行が可能です。<br>
その際のGoogleアプリのスコープ設定はこちらの設定がされていればよいはず<br style="display: none">
<div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fgithub.com%2Figara%2Fbot_slack_matome_channnel%2Fblob%2Fmaster%2Fdist%2Fappsscript.json%23L14-L29" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/dist/appsscript.json#L14-L29" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://github.com/igara/bot_slack_matome_channnel/blob/master/dist/appsscript.json#L14-L29</a></p>
<h3 id="web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%85%AC%E9%96%8B%E3%81%99%E3%82%8B"><a class="header-anchor-link" href="#web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%85%AC%E9%96%8B%E3%81%99%E3%82%8B" aria-hidden="true"></a> Webアプリケーション公開する</h3>
<p>スクリプトエディターのメニューから 公開 -&gt; ウェブアプリケーションとして導入から更新を実行し、</p>
<p><img src="/images/bot_slack_matome_channnel/update_gas_web_appllication.jpg" alt=""></p>
<p>公開したWebアプリケーションのURLをコピーします。</p>
<h3 id="slack%E3%81%AEevent-subscriptions%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B"><a class="header-anchor-link" href="#slack%E3%81%AEevent-subscriptions%E3%82%92%E7%99%BB%E9%8C%B2%E3%81%99%E3%82%8B" aria-hidden="true"></a> SlackのEvent Subscriptionsを登録する</h3>
<p><strong>Request URL</strong> に公開したGASのWebアプリケーションのURLを貼り、<strong>Verified</strong> が表示されるか確認します。</p>
<p><img src="/images/bot_slack_matome_channnel/slack_event_request_url.jpg" alt=""></p>
<p>確認できたら、 <strong>Subscribe to bot events</strong> の項目で</p>
<ul>
<li>message.channels</li>
</ul>
<p>を登録してください。</p>
<p><img src="/images/bot_slack_matome_channnel/slack_event_bot.jpg" alt=""></p>
<p>以上で設定は完了です。<br>
Slackで対象のチャンネルを作成してメッセージを投稿してみてボットのメッセージが送られるようになっていたら成功です。</p>
<h2 id="%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E9%9B%91%E3%81%AB%E8%AA%AC%E6%98%8E"><a class="header-anchor-link" href="#%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E9%9B%91%E3%81%AB%E8%AA%AC%E6%98%8E" aria-hidden="true"></a> ソースコード雑に説明</h2>
<h3 id="src%2Ftasks%2Fcreate_clasp_json.ts"><a class="header-anchor-link" href="#src%2Ftasks%2Fcreate_clasp_json.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/tasks/create_clasp_json.ts" target="_blank" rel="nofollow noopener noreferrer">src/tasks/create_clasp_json.ts</a></h3>
<p><a href="https://github.com/google/clasp#create" target="_blank" rel="nofollow noopener noreferrer">https://github.com/google/clasp#create</a> に該当するもの<br>
Spreadsheetとスクリプトエディターの名前を一緒にしたかったから自作したようなもの</p>
<h3 id="src%2Fgas%2Fcreate_sheets.ts"><a class="header-anchor-link" href="#src%2Fgas%2Fcreate_sheets.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/create_sheets.ts" target="_blank" rel="nofollow noopener noreferrer">src/gas/create_sheets.ts</a></h3>
<p>GASとして使用する関数<br>
GAS経由にシートを作成する</p>
<div class="code-block-container"><pre class="language-ts"><code class="language-ts">Spreadshhet<span class="token punctuation">.</span><span class="token function">deleteSheet</span><span class="token punctuation">(</span>Spreadshhet<span class="token punctuation">.</span><span class="token function">getSheetByName</span><span class="token punctuation">(</span><span class="token string">"channels"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> channelsSheetColumnNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ChannelsSheet <span class="token operator">=</span> Spreadshhet<span class="token punctuation">.</span><span class="token function">insertSheet</span><span class="token punctuation">(</span><span class="token string">"channels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ChannelsSheet<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> channelsSheetColumnNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValues</span><span class="token punctuation">(</span><span class="token punctuation">[</span>channelsSheetColumnNames<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>な削除して再度シート作成するような作りになっている</p>
<p>過去に作ったGoogle API経由でCSVを元にシートを作成するのもありっちゃあり<br style="display: none">
<div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fgithub.com%2Figara%2Fspreadsheet_master%2Fblob%2Fmaster%2Fsrc%2Ftasks%2Frecreate_spreadsheet.ts" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://github.com/igara/spreadsheet_master/blob/master/src/tasks/recreate_spreadsheet.ts" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://github.com/igara/spreadsheet_master/blob/master/src/tasks/recreate_spreadsheet.ts</a></p>
<p>ローカルPCで実行するよりGASの環境で実行したい気持ちが今回強かった</p>
<h3 id="src%2Fgas%2Fdo_post.ts"><a class="header-anchor-link" href="#src%2Fgas%2Fdo_post.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/do_post.ts" target="_blank" rel="nofollow noopener noreferrer">src/gas/do_post.ts</a></h3>
<p>SlackのEvent Subscriptions経由できたメッセージがリクエストされて処理を実行するGASの関数</p>
<p>今回設定したEvent Subscriptionsがメッセージに対する更新系もプッシュされていたので除外するために書いた処理がこちら</p>
<p><div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fgithub.com%2Figara%2Fbot_slack_matome_channnel%2Fblob%2Fmaster%2Fsrc%2Fgas%2Fdo_post.ts%23L9-L23" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/do_post.ts#L9-L23" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/do_post.ts#L9-L23</a></p>
<p>必要に応じて除外しているものを活用してみるのも良さそう<br>
なおGASの利用枠</p>
<h3 id="src%2Fgas%2Fget_channels.ts"><a class="header-anchor-link" href="#src%2Fgas%2Fget_channels.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/get_channels.ts" target="_blank" rel="nofollow noopener noreferrer">src/gas/get_channels.ts</a></h3>
<p>GASとして使用する関数<br>
Slack APIを叩いてすべてのチャンネルを取得する<br>
スクリプトエディターで定期実行するトリガーを設定できるのでこの関数を時間実行できると良いかも</p>
<p>トリガーの設定もコード化したい場合は下記のコードを参考にすればいけるんですかね？（試してない<br style="display: none">
<div class="embed-zenn-link"><iframe src="https://card.zenn.dev/?url=https%3A%2F%2Fdevelopers.google.com%2Fapps-script%2Fguides%2Ftriggers%2Finstallable%23managing_triggers_programmatically" frameborder="0" scrolling="no" loading="lazy"></iframe></div><a href="https://developers.google.com/apps-script/guides/triggers/installable#managing_triggers_programmatically" style="display: none" target="_blank" rel="nofollow noopener noreferrer">https://developers.google.com/apps-script/guides/triggers/installable#managing_triggers_programmatically</a></p>
<h3 id="src%2Fgas%2Fget_users.ts"><a class="header-anchor-link" href="#src%2Fgas%2Fget_users.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/gas/get_users.ts" target="_blank" rel="nofollow noopener noreferrer">src/gas/get_users.ts</a></h3>
<p>GASとして使用する関数<br>
Slack APIを叩いてすべてのユーザを取得する</p>
<h3 id="src%2Futils%2Ftasks%2Fclasp_json.ts"><a class="header-anchor-link" href="#src%2Futils%2Ftasks%2Fclasp_json.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/utils/tasks/clasp_json.ts" target="_blank" rel="nofollow noopener noreferrer">src/utils/tasks/clasp_json.ts</a></h3>
<p>JSONファイルでも型定義したい思いが強くてtsファイル経由で読み込もうとしている</p>
<h3 id="src%2Futils%2Ftasks%2Fclasprc_json.ts"><a class="header-anchor-link" href="#src%2Futils%2Ftasks%2Fclasprc_json.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/utils/tasks/clasprc_json.ts" target="_blank" rel="nofollow noopener noreferrer">src/utils/tasks/clasprc_json.ts</a></h3>
<p>JSONファイルでも型定義したい思いが強くてtsファイル経由で読み込もうとしている</p>
<h3 id="src%2Futils%2Ftasks%2Fgoogle.ts"><a class="header-anchor-link" href="#src%2Futils%2Ftasks%2Fgoogle.ts" aria-hidden="true"></a> <a href="https://github.com/igara/bot_slack_matome_channnel/blob/master/src/utils/tasks/google.ts" target="_blank" rel="nofollow noopener noreferrer">src/utils/tasks/google.ts</a></h3>
<p>Google API クライアント扱う</p>

</div>