---
title: "Next.js 14.2.28 -> 15.3.1 ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å¯¾å¿œ"
emoji: "ğŸ†™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "turbopack", "react", "sentry"]
published: true
publication_name: chot
---

# ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

- [CVE-2025-29927](https://vercel.com/blog/postmortem-on-next-js-middleware-bypass#patched-versions)ã«ã‚ˆã‚‹Next.jsã®Middlewareã§ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è„†å¼±æ€§å¯¾å¿œã—ã¦ãŸã®ã‚‚ã‚ã‚Šã€14 -> 15ã«ã‚ã’ã‚ˆã†ã¨ã™ã‚‹å¯¾å¿œã¯ä¸¦è¡Œã—ã¦æ¤œè¨ã—ã¦ãŸ
  - è„†å¼±æ€§å¯¾å¿œå‰ã‹ã‚‰ `npx @next/codemod@canary upgrade latest` ã«ã‚ˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã‚“ãªã‚Š15ã«ã‚¢ãƒƒãƒ—ã§ããªã„ã‹æ°—ã«ãªã£ã¦ã„ãŸã®ã‚‚ã‚ã‚‹
    - æ•°ãƒ¶æœˆã«1å›ã¯codemodå®Ÿè¡Œã—ã¦ã¿ã‚‹ãã‚‰ã„ã¯æ°—ã«ãªã£ã¦ãŸ
      - æ‰‹ä½œæ¥­çš„ã«å¤‰æ›´ã—ãªã„ã¨ã„ã‘ãªã„ç®‡æ‰€ãŒå¤šãã™ãã«ã¯å¯¾å¿œã§ãã‚“ã¨ãªã‚Šã ã„ã¶è¦‹é€ã£ã¦ãŸãŒcodemodãŒæ”¹å–„ã•ã‚Œã¦ã„ãã€è‡ªå‹•ã§æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ãã¦ãŸã®ã§æ€ã„åˆ‡ã‚ŠãŒã¤ã„ãŸ
    - codemodã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯@manabuyasudaã•ã‚“ã®
      [ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä½œæ¥­ã‚’è¨ˆç”»çš„ã«é€²ã‚ã‚‹ãŸã‚ã®æ‰‹é †](https://zenn.dev/chot/articles/3d034e077a1698)
      ã‚’ã¿ã‚‹ã¨è‰¯ã•ãã†
      
https://zenn.dev/chot/articles/3d034e077a1698
  
- Next.js 15.3 ã‹ã‚‰ã®[Turbopack Builds (alpha)](https://nextjs.org/blog/next-15-3#turbopack-builds-alpha)
  - ãƒ‡ãƒ—ãƒ­ã‚¤é€Ÿãã—ãŸã‹ã£ãŸ
- ã¤ã„ã§ã«Reactã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã‹ã£ãŸ
  - MUI etc...

# å¤‰æ›´ç‚¹

## `npx @next/codemod@canary upgrade latest` å®Ÿè¡Œ

ã“ã®æ™‚ã®codemodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ `15.4.0-canary.20` ã ã£ãŸ

ä»¥ä¸‹ã€ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ãŸå†…å®¹

```
? Please manually add "--turbopack" to your dev command. â€º run-p dev:*
  -> Enter

? The following codemods are recommended for your upgrade. Select the ones to apply.
  -> (v15.0.0-canary.171) next-async-request-api ã‚’é¸æŠ


? Would you like to run the React 19 upgrade codemod?
  -> Enter

? Would you like to run the React 19 Types upgrade codemod?
  -> Enter

Upgrading your project to Next.js 15.3.1...
  -> page.tsxã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹searchParams, paramsãªã©ã®éåŒæœŸAPIã®ç½®æ›ãŒè‡ªå‹•ã§è¡Œã‚ã‚Œã‚‹
     ãã®ä»–ã€next/headersã‚’ä½¿ç”¨ã—ãŸheaders, cookiesãªã©ã®éåŒæœŸAPIã«ã¯
     /* @next-codemod-error The APIs under 'next/headers' are async now, need to be manually awaited. */
     ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã•ã‚Œã€async / awaitã«ç½®æ›ã•ã‚ŒãŸ

? Is your app deployed to Vercel? (Required to apply the selected codemod)
  -> n ã‚’å…¥åŠ›ã— Enter
```

### `package.json`ã®å¤‰æ›´ç‚¹

```diff text
- "@next/bundle-analyzer": "^14.1.0",
+ "@next/bundle-analyzer": "15.3.1",

- "@next/third-parties": "^14.2.5",
+ "@next/third-parties": "15.3.1",

- "next": "14.2.28",
+ "next": "15.3.1",

- "react": "^18",
+ "react": "19.1.3",

- "react-dom": "^18",
+ "react-dom": "19.1.3",

- "@types/react": "^18",
+ @types/react": "19.1.2",

- "@types/react-dom": "^18",
+ "@types/react-dom": "19.1.3",

- "eslint-config-next": "14.0.4",
+ "eslint-config-next": "15.3.1",
```

ã‚ã¨ã¯æ‰‹å…¥åŠ›ã§ npm scriptã«ã‚ã‚‹ `next dev`ã€`next build` ã« `--turbopack`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ãŸ

### `/* @next-codemod-error The APIs under 'next/headers' are async now, need to be manually awaited. */` ã®ã‚³ãƒ¡ãƒ³ãƒˆç®‡æ‰€èª¿æ•´ä¾‹

```diff ts
import { cookies } from 'next/headers';

- export const getCookie = (name: string) => {
-   return cookies().get(name)?.value || '';
+ export const getCookie = async (name: string) => {
+   return (await cookies()).get(name)?.value || '';
}
```

ãƒ­ã‚°ã‚¤ãƒ³å‘¨ã‚Šã§Cookieæ‰±ã£ã¦ã‚‹å‡¦ç†ãŒã‚ã£ãŸã®ã§å®Ÿéš›ã«å‹•ä½œç¢ºèªã—ãŸ

### Next.jsã®å‹å®šç¾©å‚ç…§å…ˆã‚’ `next/types` ã«å¤‰æ›´

```diff ts
- import { NextPage } from 'next';
+ import { NextPage } from 'next/types';
```

ã“ã®ã¨ãã¯ã¾ã codemodã§è‡ªå‹•ã«ç½®æ›ã•ã‚Œãªã‹ã£ãŸã®ã§æ‰‹å‹•ã§ä¿®æ­£

## MUIå‘¨ã‚Šæ›´æ–°

storybook + storycapã«ã‚ˆã‚‹ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚ã£ãŸã®ã§ã‚¹ã‚¯ã‚·ãƒ§ã®å·®åˆ†ç¢ºèªãã‚‰ã„ã§æ¸ˆã‚“ã 

### `package.json`ã®å¤‰æ›´ç‚¹

```diff text
- "@emotion/cache": "^11.11.0",
+ "@emotion/cache": "11.14.0",

- "@emotion/react": "^11.11.4",
+ "@emotion/react": "11.14.0",

- "@emotion/styled": "^11.11.0",
+ "@emotion/styled": "11.14.0",

- "@mui/base": "^5.0.0-beta.40",
+ "@mui/base": "^5.0.0-beta.70",

- "@mui/icons-material": "^5.15.13",
+ "@mui/icons-material": "7.0.2",

- "@mui/material": "^5.15.13",
+ "@mui/material": "7.0.2",

- "@mui/material-nextjs": "^5.15.11",
+ "@mui/material-nextjs": "7.0.2",

- "@mui/x-date-pickers": "^7.2.0",
+ "@mui/x-date-pickers": "8.2.0",
```

### `@mui/material` 5.X -> 7.Xã«ã‚ˆã‚‹å¤‰æ›´ç‚¹

#### Gridã®ä»•æ§˜ãŒå¤‰ã‚ã£ãŸ

```diff
<Grid container>
-  <Grid item md={3}>
+  <Grid size={{
+      md: 3,
+  }}>
    ...
  </Grid>
</Grid>
```

## Auth.jsæ›´æ–°

ãƒ­ã‚°ã‚¤ãƒ³ / ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚‹Cookieã®å‡¦ç†ã¨åŒæ™‚ã«ç¢ºèª

### `package.json`ã®å¤‰æ›´ç‚¹

```diff text
- "next-auth": "^5.0.0-beta.5",
+ "next-auth": "5.0.0-beta.27",
```

## Sentryæ›´æ–°

[Step 2: Verify Your Setup](https://docs.sentry.io/platforms/javascript/guides/nextjs/#step-2-verify-your-setup) ã‚ˆã‚Š

:::message

> The Sentry SDK doesn't yet fully support Turbopack production builds (next build --turbopack) as Turbopack production builds are still in alpha.
> 
> If you upgraded the Sentry SDK to the latest version and installed Next.js on version 15.3.0 or later, the SDK will capture all data as expected, however, it is currently not possible to apply sourcemaps to Turbopack production builds.
> 
> Turbopack in dev-mode (next dev --turbopack) is fully supported.
> 
> Check the latest information on Sentry's support for Turbopack on GitHub.

:::

[Next.js Turbopack Support](https://github.com/getsentry/sentry-javascript/issues/8105)ã«ã¦ç¾çŠ¶ã®ã‚µãƒãƒ¼ãƒˆã®ç¯„å›²ã¯ä»¥ä¸‹ã«ãªã‚‹


Current Status (Last Update May 5, 2025)

| Feature | Support | Notes |
| ---- | ---- | ---- |
| Next.js app compiles and runs without issues | âœ… |  |
| Server-side instrumentation | âœ… |  |
| Client-side instrumentation | âœ… | - Upgrade to SDK version 9.9.0 or greater <br> - Upgrade to Next.js canary 15.3.0-canary.8 or greater <br> - Add instrumentation-client.ts file with Sentry.init() call. (sentry.client.config.ts can be replaced with instrumentation-client.ts. It serves the same purpose.) |
| Server-side instrumentation | âœ… | - Upgrade SDK to version 9.11.0 |
| Source Maps | âŒ | - Needs runAfterProductionCompile hook implemented in Next.js (done in Next.js 15.4.0-canary.19) <br> - Needs way to inject debug IDs into bundles implemented in Next.js |
| React Component Name Annotations | âŒ | - Needs way to transform code in Next.js <br> - Will likely not be possible for the forseeable future |

å¯¾è±¡ã®ç”»é¢ã§ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã•ãˆåé›†ã§ãã¦ã„ã‚Œã°è‰¯ã„ã®ã§Source Mapsã¯æœªå¯¾å¿œã§ã‚‚è‰¯ã„åˆ¤æ–­ã‚’ã—ãŸ

### `package.json`ã®å¤‰æ›´ç‚¹

```diff text
- "@sentry/nextjs": "^7.102.0",
+ "@sentry/nextjs": "9.17.0",

```

### `@sentry/nextjs` 7.X -> 9.Xã«ã‚ˆã‚‹å¤‰æ›´ç‚¹

7.Xã®ã¨ãã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§Sentryã®è¨­å®šã‚’è¡Œãªã£ã¦ã„ãŸ

```
sentry.client.config.ts
sentry.edge.config.ts
sentry.server.config.ts
```

[Initialize Sentry Client-Side and Server-Side SDKs](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#initialize-sentry-client-side-and-server-side-sdks)ã€[Register Sentry Server-Side SDK Initialization](https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/#register-sentry-server-side-sdk-initialization)

ã‚ˆã‚ŠSentryã®è¨­å®šã‚’ `src/instrumentation.ts`ã¨ `src/instrumentation-client.ts` ã«ç§»ã—ãŸ

```ts:src/instrumentation.ts
import * as Sentry from '@sentry/nextjs';

export function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    Sentry.init({
      environment: process.env.NEXT_PUBLIC_ENV,
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN_KEY,

      integrations: [
        Sentry.captureConsoleIntegration({
          levels: ['error'],
        }),
      ],
      attachStacktrace: true,

      // Set tracesSampleRate to 1.0 to capture 100%
      // of transactions for performance monitoring.
      // We recommend adjusting this value in production
      tracesSampleRate: 0,
    });
  }
  if (process.env.NEXT_RUNTIME === 'edge') {
    Sentry.init({
      environment: process.env.NEXT_PUBLIC_ENV,
      dsn: process.env.NEXT_PUBLIC_SENTRY_DSN_KEY,

      integrations: [
        Sentry.captureConsoleIntegration({
          levels: ['error'],
        }),
      ],
      attachStacktrace: true,

      // Set tracesSampleRate to 1.0 to capture 100%
      // of transactions for performance monitoring.
      // We recommend adjusting this value in production
      tracesSampleRate: 0,
    });
  }
}
```


```ts:src/instrumentation-client.ts
import * as Sentry from '@sentry/nextjs';
Sentry.init({
  environment: process.env.NEXT_PUBLIC_ENV,
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN_KEY,
  // Replay may only be enabled for the client-side
  integrations: [
    Sentry.replayIntegration(),
    Sentry.captureConsoleIntegration({
      levels: ['error'],
    }),
  ],
  attachStacktrace: true,

  // Set tracesSampleRate to 1.0 to capture 100%
  // of transactions for performance monitoring.
  // We recommend adjusting this value in production
  tracesSampleRate: 0,
});

export const onRouterTransitionStart = Sentry.captureRouterTransitionStart;
```

# çµ‚ã‚ã‚Š

MUIã‚„Sentryãªã©1ä¸–ä»£é£›ã°ã—ã¦æ›´æ–°ã—ã¦ãŸã‚Šã™ã‚‹ã®ã§å¯¾å¿œã¨ã—ã¦ãŠç²—æœ«ãªã¨ã“ãŒã‚ã‚‹ã‹ã‚‚
